# RanchOS - Native iOS Application

A native iOS application for RanchOS, the smart ranch management system with real-time monitoring of cattle, sensors, gates, cameras, and ranch operations.

## Overview

RanchOS iOS is a **native Swift/SwiftUI application** that provides full-featured access to the RanchOS platform on iPhone and iPad devices. It includes:

- Multi-tenant server URL configuration
- Secure authentication with Keychain credential storage
- Real-time cattle tracking on interactive maps
- Live sensor monitoring dashboard
- Security camera feeds with WKWebView
- Herd management and stray detection
- Admin panel for configuration

## Architecture

### Multi-Tenant Support

**Critical Feature**: This app supports multiple ranch customers, each with their own server instance:

- On first launch, users configure their unique ranch server URL (e.g., `https://ranch-3strands.ranchos.app`)
- Server URL is persisted locally
- All API calls are made to the configured server
- Users can change servers from the Admin panel

### Key Components

```
RanchOS/
â”œâ”€â”€ RanchOSApp.swift              # App entry point, AppState management
â”œâ”€â”€ ContentView.swift              # Main router (config â†’ login â†’ dashboard)
â”œâ”€â”€ Models/
â”‚   â””â”€â”€ RanchModels.swift         # API response models matching backend
â”œâ”€â”€ Services/
â”‚   â”œâ”€â”€ APIClient.swift           # URLSession REST client with async/await
â”‚   â””â”€â”€ ServerConfigManager.swift # Server URL configuration manager
â”œâ”€â”€ Utilities/
â”‚   â””â”€â”€ SecureStorage.swift       # Keychain credential storage
â””â”€â”€ Views/
    â”œâ”€â”€ ServerConfigView.swift    # First-run server configuration
    â”œâ”€â”€ LoginView.swift           # Authentication screen
    â”œâ”€â”€ MainTabView.swift         # Tab navigation + RanchDataManager
    â”œâ”€â”€ MapTabView.swift          # MapKit with cattle/gate annotations
    â”œâ”€â”€ SensorsTabView.swift      # Sensor monitoring dashboard
    â”œâ”€â”€ CamerasTabView.swift      # WKWebView camera grid
    â”œâ”€â”€ CattleTabView.swift       # Herd list and management
    â””â”€â”€ AdminTabView.swift        # Admin settings (admin role only)
```

## Technical Stack

- **Language**: Swift 5.9+
- **UI Framework**: SwiftUI
- **Minimum iOS Version**: iOS 17.0+
- **Map Integration**: MapKit (native Apple Maps)
- **Networking**: URLSession with async/await
- **Security**: iOS Keychain Services
- **Web Content**: WKWebView for YouTube embeds

### Why MapKit Instead of Mapbox?

While the web app uses Mapbox GL JS, the iOS app uses **native MapKit** for several reasons:

1. **No Third-Party Dependencies**: MapKit is built into iOS, no SDK installation needed
2. **Better Performance**: Native integration with iOS graphics pipeline
3. **Smaller App Size**: No embedded Mapbox SDK (saves ~20MB)
4. **Simpler Integration**: SwiftUI Map view with native annotations
5. **Cost**: MapKit is free, no token management required

The map functionality is equivalent - cattle markers, gates, fences, and pastures all render correctly.

## Setup Instructions

### Prerequisites

1. **Xcode 15.0 or later** installed on macOS
2. **iOS 17.0+ device or simulator** for testing
3. **RanchOS backend server** running and accessible

### Opening the Project

Since this is a manual project structure (not generated by Xcode), you have two options:

#### Option 1: Create New Xcode Project (Recommended)

1. Open Xcode
2. Create a new iOS App project:
   - Product Name: `RanchOS`
   - Interface: SwiftUI
   - Language: Swift
   - Minimum iOS Version: 17.0
3. Replace the generated files with the Swift files from this directory:
   - Copy all files from `RanchOS/` to your Xcode project
   - Ensure all files are added to the target
4. Add required capabilities in Xcode:
   - Maps (for MapKit)
   - Keychain Sharing (for SecureStorage)

#### Option 2: Use Provided Project Structure

1. Open `RanchOS.xcodeproj` in Xcode
2. If prompted about missing files, re-add them from the `RanchOS/` directory
3. Configure build settings as needed

### Configuration

#### 1. Server URL Configuration

On first launch, the app presents a server configuration screen. Users must enter their ranch's server URL:

- **Production**: `https://ranch-yourname.ranchos.app`
- **Local Development**: `http://localhost:8082`
- **Network Testing**: `http://YOUR_IP:8082` (e.g., `http://192.168.1.100:8082`)

**Important**: For local testing, ensure your Mac and iOS device are on the same network, and use your Mac's local IP address (not `localhost`).

#### 2. App Transport Security (ATS)

For development with HTTP (localhost/local IP), add to `Info.plist`:

```xml
<key>NSAppTransportSecurity</key>
<dict>
    <key>NSAllowsLocalNetworking</key>
    <true/>
    <key>NSAllowsArbitraryLoads</key>
    <true/>
</dict>
```

**Remove this for production builds** - only use HTTPS in production.

#### 3. Keychain Entitlements

Add Keychain Sharing capability:

1. Select project in Xcode
2. Select RanchOS target
3. Go to "Signing & Capabilities"
4. Click "+ Capability"
5. Add "Keychain Sharing"
6. Add keychain group: `com.3strandscattle.RanchOS`

### Building and Running

1. Select target device (simulator or physical device)
2. Click Run (Cmd+R) in Xcode
3. On first launch:
   - Enter server URL
   - Tap "Continue to Login"
   - Enter credentials (demo: username `jay`, password `3strands`)

## API Integration

### Endpoints Used

The app communicates with the RanchOS Express backend via REST API:

```
POST   /api/login           # Authentication
GET    /api/config          # Mapbox token, ranch center, fence
GET    /api/sensors         # Sensor readings
GET    /api/herd            # Cattle positions
GET    /api/gates           # Gate statuses
POST   /api/gates           # Toggle gate
GET    /api/cameras         # Camera feeds
GET    /api/chute           # Chute transactions
GET    /api/stray-alerts    # AI stray detection
GET    /api/pastures        # Pasture boundaries
GET    /api/version         # Version info
```

### Polling Intervals

The app polls the backend at intervals matching the web app:

- **Sensors**: 5 seconds
- **Herd**: 4 seconds
- **Gates**: 6 seconds
- **Chute**: 8 seconds
- **Cameras**: 10 seconds
- **Stray Alerts**: 7 seconds

Polling starts when the main dashboard appears and stops when the app backgrounds.

## Features

### 1. Server Configuration

- Multi-tenant server URL input
- URL validation (http/https)
- Server health check before proceeding
- Persistent storage of server URL

### 2. Authentication

- Username/password login
- Optional "Remember credentials" toggle
- Secure Keychain storage
- Auto-fill saved credentials
- Change server option

### 3. Live Map

- MapKit with hybrid satellite view
- Real-time cattle markers with tap-to-view details
- Gate markers (color-coded by status)
- Stray cattle alerts (orange warning markers)
- Ranch center marker
- Fence polygon overlay
- Pasture boundaries
- Zoom controls and compass
- Center-on-ranch button

### 4. Sensor Dashboard

- Real-time sensor status cards (SYSTEM, WATER, FENCE, GATE, NETWORK, ALERTS)
- Color-coded indicators (green/yellow/red)
- System status banner
- Gate controls (open/close)
- Latest chute transaction card

### 5. Security Cameras

- Quad camera grid view
- WKWebView YouTube embeds
- Online/offline status indicators
- Predator detection alerts
- Full-screen camera view
- Camera location labels

### 6. Cattle Management

- Searchable cattle list
- AI stray detection alerts (priority section)
- Individual cattle details (weight, temperature, vaccines)
- Recent chute activity log
- Quick access to cattle on map

### 7. Admin Panel (Admin Role Only)

- Server URL display and change
- User account info
- Ranch statistics
- Version information
- Refresh all data
- Logout

## Security

### Credential Storage

- Passwords stored in iOS Keychain (encrypted at rest)
- Keychain items protected with `kSecAttrAccessibleWhenUnlockedThisDeviceOnly`
- Credentials never leave the device
- Automatic clearing on logout

### Network Security

- Support for HTTPS connections
- Certificate validation (production)
- Timeout configurations (30s request, 60s resource)
- Error handling for network failures

### Authentication Flow

1. User enters credentials
2. POST to `/api/login` with JSON body
3. Backend validates and returns role
4. On success: save to Keychain (if requested), update AppState
5. On failure: display error, clear sensitive data

## Data Models

All models conform to `Codable` and match the Express backend exactly:

```swift
// Authentication
LoginRequest { username, password }
LoginResponse { status, user, role }

// Configuration
ConfigResponse { mapboxToken, ranchCenter, fence }

// Sensors
SensorsResponse { sensors: [String: SensorReading] }

// Herd
HerdResponse { herd: [Cattle] }
  Cattle { id, name, lat, lon, weight, temperature, vaccines }

// Gates
GatesResponse { gates: [Gate] }
  Gate { id, lat, lon, status }

// Cameras
CamerasResponse { cameras: [Camera] }
  Camera { camera, name, location, status, embedUrl, predator_detected }

// Chute
ChuteResponse { chute: ChuteTransaction }

// Stray Alerts
StrayAlertsResponse { alerts: [StrayAlert] }

// Pastures
PasturesResponse { pastures: [Pasture] }
```

## Troubleshooting

### Cannot Connect to Server

**Issue**: "Cannot reach server at this URL"

**Solutions**:
- Verify server is running (`docker compose up` or `npm run dev`)
- For local testing, use Mac's IP address, not `localhost`
- Check firewall settings
- Ensure iOS device and server are on same network
- For HTTP, verify ATS exceptions in Info.plist

### Login Failed

**Issue**: "Invalid credentials" error

**Solutions**:
- Verify username and password are correct
- Check server logs for authentication errors
- Try demo credentials: `jay` / `3strands`
- Ensure backend users.json exists and is readable

### Map Not Loading

**Issue**: Map shows blank or no annotations

**Solutions**:
- Check `/api/config` returns valid coordinates
- Verify `/api/herd` returns cattle with lat/lon
- Check console for API errors
- Ensure location permissions granted (if using user location)

### Cameras Not Loading

**Issue**: Camera feeds show "Camera Offline"

**Solutions**:
- Verify camera `embedUrl` in `/api/cameras` response
- Check YouTube video is embeddable (not age-restricted)
- Test URL in Safari/Chrome
- Check WKWebView console for errors

### App Crashes on Launch

**Solutions**:
- Clean build folder (Cmd+Shift+K)
- Delete derived data
- Ensure iOS version is 17.0+
- Check Xcode console for crash logs

## Development Tips

### Testing with Local Backend

1. Start backend: `npm run dev` (runs on port 8082)
2. Find your Mac's local IP:
   ```bash
   ifconfig | grep "inet " | grep -v 127.0.0.1
   ```
3. Enter IP in app: `http://192.168.1.X:8082`
4. Login with demo credentials

### Debugging Network Requests

Enable debug logging in APIClient.swift (already enabled in DEBUG):

```swift
#if DEBUG
print("ðŸ“¡ \(request.httpMethod ?? "GET") \(request.url?.path ?? "") -> \(httpResponse.statusCode)")
#endif
```

### Simulating Different Devices

Test on:
- iPhone SE (compact width)
- iPhone 15 Pro (standard)
- iPad Pro 12.9" (regular width, split screen)

### Live Preview in Xcode

Use SwiftUI previews for rapid iteration:

```swift
#Preview {
    MapTabView()
        .environmentObject(RanchDataManager())
        .environmentObject(AppState())
}
```

## Future Enhancements

### Potential Features

- [ ] Push notifications for alerts (APNs)
- [ ] Offline mode with Core Data caching
- [ ] Widget support for at-a-glance stats
- [ ] Apple Watch companion app
- [ ] Siri shortcuts for common tasks
- [ ] Background refresh for stray alerts
- [ ] iPad-optimized layouts (sidebar navigation)
- [ ] Dark/light mode toggle (currently dark only)
- [ ] Export cattle reports as PDF
- [ ] Camera recording and playback
- [ ] Geofencing alerts for cattle

### Backend Improvements Needed

- [ ] Token-based authentication (JWT)
- [ ] WebSocket support for real-time updates (eliminate polling)
- [ ] Push notification service
- [ ] Image upload for cattle photos
- [ ] Historical data endpoints (trends, charts)

## Deployment

### App Store Submission

1. Configure signing in Xcode:
   - Set Team
   - Choose Distribution certificate
   - Configure App ID with capabilities

2. Update Info.plist:
   - Remove ATS exceptions (use HTTPS only)
   - Add privacy usage descriptions (location, camera)
   - Set version and build numbers

3. Create archive:
   - Product â†’ Archive
   - Upload to App Store Connect

4. Submit for review:
   - Provide test credentials
   - Document server URL configuration
   - Include screenshots (5.5" and 6.5" iPhones, iPad)

### TestFlight Beta

1. Upload build to App Store Connect
2. Add beta testers
3. Distribute via TestFlight
4. Collect feedback before public release

## License

Â© 2024 3 Strands Cattle Co., LLC. All rights reserved.

## Support

For issues or questions:
- Check backend compatibility (Express server must be running)
- Review server logs for API errors
- Verify network connectivity
- Contact ranch administrator for server URL

---

**Built with Swift and SwiftUI for iOS 17+**
